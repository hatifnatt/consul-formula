# consul formula

Формула для установки и настройки HashiCorp Consul.

## Использование

* Создаем pillar с данными, см. `pillar.example` для качестве примера, привязываем его к хосту в pillar top.sls.
* Применяем стейт на целевой хост `salt 'consul-01*' state.sls service.consul saltenv=base pillarenv=base`.
* Применить формулу к хосту в state top.sls, для выполнения оной при запуске `state.highstate`.

__ВНИМАНИЕ__  

С настройками по умолчанию запущенный consul agent не будет работать, т.к. он будет запущен в режиме клиента, но адреса для подключения к серверу у него не будет. Таким образом, для запуска сервиса __обязательно__ нужно создать pillar с корректными данными.

## Доступные стейты

* [consul](#consul)
* [consul.install](#consul.install)
* [consul.config](#consul.config)
* [consul.acl_bootstrap](#consul.acl_bootstrap)

### consul

Мета стейт, выполняет все необходимое для настройки сервиса на отдельном хосте.

### consul.install

Скачивает и устанавливает бинарник, создает systemd юнит файл.

#### Скрипт резервного копирования

При установке параметра `backup_helper: True` `consul.install` так же установит вспомогательный bash скрипт для выполнения резервного копирования. Скрипт устанавливается как `/usr/local/bin/consul_backup`, скрипт должен выполняться от имени пользователя Consul (обычно consul) или от имени суперпользователя, т.к. скрипт извлекает мастер токен из конфигурационного файла агента Counsul. Мастер токен необходим для выполнения команды `consul snapshot save`. На самом деле подойдет любой токен с правами management, но мастер токен проще всего извлечь.

Скрипт принимает два параметра:

* `--backup` - создать резервную копию, которая сохранится в директории `backup_dir` указанной в pillar, по умолчанию это `/var/lib/consul/backup`.
* `--clean` - удалить все файлы из директории `backup_dir`, проще говоря, очистка временного хранилища резервных копий, после их переноса в архивное хранилище.

Пример _sudoers_ правила, которое позволит пользователю выполняющему резервное копирование запустить скрипт:

```
backupuser ALL = (consul) NOPASSWD:/usr/local/bin/consul_backup
```

Пример pillar для использования совместно с [users-formula](https://github.com/saltstack-formulas/users-formula), в данном случае настраиваем для пользователя `backuppc` право выполнять `/usr/local/bin/consul_backup` от имени пользовател `consul`. Данный pillar может быть подключен к нужному хосту в дополнение к основному (общему) pillar для настройки пользователя `backuppc`, для того чтоб два pillar были слиты в один требуется чтоб был включен параметр `pillar_merge_lists: True` в конфигурации `salt-master`.

```yaml
users:
  backuppc:
    sudo_rules:
      - ALL = (consul) NOPASSWD:/usr/local/bin/consul_backup
```

### consul.config

Создает конфигурационный файл. Создает самоподписныой сертификат, или устанавливает готовый сертификат. Запускает сервис.

### consul.acl_bootstrap

Позволяет инициализировать ACL подсистему: создать policy, а так же настроить анонимный и агентский токены.

__ВНИМАНИЕ__  

Данный стейт требует доработки в связи с изменениями в работе ACL начиная с версии 1.5.0

На данный момент при первом прогоне формулы невозможно полностью сформировать конфигурационный файл Consul, требуется запущенный Consul для генерации агентского токена (см. [consul issue #4977](https://github.com/hashicorp/consul/issues/4977)). Таким образом, для полной настройки сервера "с нуля" необходимо запустить формулу 2 раза:

* Первый запуск - создание политик, получение токена для агента, ручное сохранение полученного токена в конфигурации, путем добавления его в pillar
* Второй запуск - Consul использует агентский токен из конфигурации, достигнуто работоспосбное состояние.
